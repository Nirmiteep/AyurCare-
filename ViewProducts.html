<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayurvedic Store | Ayurcare</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            /* Your requested specific theme color */
            --primary-green: #2b7714;
            --hover-green: #1e550e;
            --bg-light: #f4f7f6;
            --text-dark: #1f2937;
        }

        body { 
            background-color: var(--bg-light); 
            font-family: 'Inter', sans-serif; 
            color: var(--text-dark);
        }

        /* --- NAVBAR STYLING --- */
        .navbar { 
            background-color: #ffffff !important;
            border-bottom: 3px solid var(--primary-green) !important; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.03) !important;
        }
        .navbar-brand.text-success {
            color: var(--primary-green) !important;
            font-weight: 800 !important;
            font-size: 1.5rem;
            letter-spacing: -0.5px;
        }
        .btn-outline-dark {
            border-color: #e5e7eb;
            font-weight: 600;
            color: var(--text-dark);
            background-color: #ffffff;
            transition: all 0.3s ease;
        }
        .btn-outline-dark:hover {
            background-color: #f9fafb;
            color: var(--primary-green);
            border-color: #d1d5db;
        }
        .badge.bg-danger {
            background-color: #ef4444 !important;
        }

        /* --- HEADINGS --- */
        h3.text-success {
            color: var(--primary-green) !important;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        /* --- PRODUCT CARD STYLING --- */
        .product-card { 
            border: 1px solid rgba(0,0,0,0.04); 
            border-radius: 16px; 
            background-color: #ffffff;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.02); 
            height: 100%; 
            display: flex;
            flex-direction: column; /* Ensures bottom elements align perfectly */
        }
        .product-card:hover { 
            transform: translateY(-6px); 
            box-shadow: 0 12px 24px rgba(43, 119, 20, 0.08); 
            border-color: rgba(43, 119, 20, 0.2);
        }

        /* Image Container */
        .img-container { 
            height: 200px; 
            background: #f9fafb; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
            border-radius: 12px;
        }
        .img-container img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; /* Prevents image from being chopped off */
            transition: transform 0.4s ease;
        }
        .product-card:hover .img-container img {
            transform: scale(1.06);
        }

        /* Card Text */
        .card-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: #111827;
            margin-top: 0.5rem;
            margin-bottom: 0.25rem;
        }
        .text-muted.small {
            color: #6b7280 !important;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Price & Badge */
        .h5.text-success.fw-bold {
            color: var(--primary-green) !important;
            font-size: 1.35rem;
            letter-spacing: 0.5px;
        }
        .badge {
            padding: 0.55em 0.8em;
            border-radius: 6px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        /* --- INPUTS & BUTTONS --- */
        /* Pushes the input/button row to the very bottom of the card evenly */
        .d-flex.gap-2 {
            margin-top: auto; 
        }

        .qty-input { 
            width: 75px; 
            text-align: center; 
            border: 1px solid #e5e7eb; 
            border-radius: 8px; 
            font-weight: 600;
            background-color: #f9fafb;
            color: #111827;
            transition: all 0.2s;
        }
        .qty-input:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(43, 119, 20, 0.15);
            background-color: #ffffff;
        }

        .btn-add { 
            background-color: var(--primary-green); 
            color: white; 
            border-radius: 8px; 
            font-weight: 600;
            padding: 10px 0;
            border: none;
            transition: all 0.2s ease;
        }
        .btn-add:hover { 
            background-color: var(--hover-green); 
            color: white; 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(43, 119, 20, 0.25);
        }
        .btn-add:disabled {
            background-color: #9ca3af;
            color: #ffffff;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Alert Styling */
        .alert-info {
            background-color: #ffffff;
            border: 1px solid rgba(43, 119, 20, 0.2);
            color: var(--text-dark);
            border-radius: 12px;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-light bg-white shadow-sm mb-4 p-3">
    <div class="container d-flex justify-content-between align-items-center">
        <a class="navbar-brand fw-bold text-success" href="UserDashboard.html">Ayurcare Store</a>
        <div>
            <a href="Cart.html" class="btn btn-outline-dark position-relative">
                ðŸ›’ My Cart
                <span id="cartBadge" class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle">0</span>
            </a>
        </div>
    </div>
</nav>

<div class="container pb-5">
    <h3 class="mb-4 text-success fw-bold">Available Ayurvedic Medicines</h3>
    <div id="productContainer" class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
        </div>
</div>

<script>
    const currentUser = JSON.parse(localStorage.getItem('user'));

    function initPatientStore() {
        if (!currentUser || currentUser.role !== 'patient') {
            window.location.href = "Login.html";
            return;
        }
        loadProductsFromLocal();
        updateCartBadge();
    }

    function loadProductsFromLocal() {
        const container = document.getElementById('productContainer');
        // Pulling from the UNIFIED key: ayur_products
        const inventory = JSON.parse(localStorage.getItem('ayur_products')) || [];
        
        if (inventory.length === 0) {
            container.innerHTML = `
                <div class="col-12 alert alert-info text-center shadow-sm border-0 py-5">
                    <h5 class="fw-bold" style="color: #2b7714;">No products are currently available in the store.</h5>
                    <p class="mb-0 text-muted">Please check back later when the doctor adds new stock.</p>
                </div>`;
            return;
        }

        container.innerHTML = '';

        inventory.forEach((product, index) => {
            const stock = parseInt(product.stock_qty || 0);
            const isOutOfStock = stock <= 0;
            const imgSource = product.image_url || 'https://via.placeholder.com/200?text=No+Image';

            const card = `
                <div class="col">
                    <div class="card product-card p-3">
                        <div class="img-container mb-3">
                            <img src="${imgSource}" alt="${product.name}">
                        </div>
                        <h5 class="card-title text-truncate" title="${product.name}">${product.name}</h5>
                        <p class="text-muted small text-truncate" title="${product.description}">${product.description || 'No description'}</p>
                        
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="h5 mb-0 text-success fw-bold">â‚¹${product.price}</span>
                            <span class="badge ${isOutOfStock ? 'bg-danger' : 'bg-secondary'}">Stock: ${stock}</span>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <input type="number" id="qty-${index}" class="qty-input" value="1" min="1" max="${stock}" ${isOutOfStock ? 'disabled' : ''}>
                            <button class="btn btn-add w-100" onclick="addToCart(${index}, ${stock})" ${isOutOfStock ? 'disabled' : ''}>
                                ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += card;
        });
    }

    function addToCart(productIndex, maxStock) {
        const selectedQty = parseInt(document.getElementById(`qty-${productIndex}`).value);

        if (selectedQty > maxStock) {
            alert(`Cannot add more than available stock (${maxStock}).`);
            return;
        }

        const inventory = JSON.parse(localStorage.getItem('ayur_products')) || [];
        const product = inventory[productIndex];
        
        let cart = JSON.parse(localStorage.getItem('ayur_cart')) || [];

        const existingItemIndex = cart.findIndex(item => item.name === product.name);
        
        if (existingItemIndex > -1) {
            const newTotal = cart[existingItemIndex].cartQty + selectedQty;
            if(newTotal > maxStock) {
                alert(`You already have ${cart[existingItemIndex].cartQty} in your cart. You cannot exceed stock limits.`);
                return;
            }
            cart[existingItemIndex].cartQty = newTotal;
        } else {
            cart.push({ 
                name: product.name, 
                price: product.price, 
                img: product.image_url, 
                cartQty: selectedQty 
            });
        }

        localStorage.setItem('ayur_cart', JSON.stringify(cart));
        updateCartBadge();
        alert(`Added ${selectedQty}x ${product.name} to your cart.`);
    }

    function updateCartBadge() {
        const cart = JSON.parse(localStorage.getItem('ayur_cart')) || [];
        document.getElementById('cartBadge').innerText = cart.length;
    }

    window.onload = initPatientStore;
</script>

</body>
</html>