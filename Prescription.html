<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayurcare - Doctor Prescription Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Inter', sans-serif; }
        .prescription-card { border-top: 5px solid #2b7714; border-radius: 10px; }
        .bg-ayur { background-color: #198754; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-ayur mb-4 shadow-sm">
    <div class="container d-flex justify-content-between">
        <span class="navbar-brand fw-bold">Ayurcare | <small>DOCTOR DASHBOARD</small></span>
        <a href="DoctorDashboard.html" class="btn btn-outline-light btn-sm">Back to Dashboard</a>
    </div>
</nav>

<div class="container pb-5" style="max-width: 800px;">
    <div class="card shadow-sm p-4 prescription-card">
        <h4 class="text-success fw-bold mb-3">Create New Prescription</h4>
        <form id="prescForm" class="row g-3">
            <div class="col-md-6">
                <label class="form-label text-success fw-bold">Select Patient</label>
                <select id="patientSelect" class="form-select" required>
                    <option value="">-- Loading Patients... --</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label text-success fw-bold">Dosha / Illness Type</label>
                <input type="text" id="illness" class="form-control" placeholder="e.g., Vata Imbalance" required>
            </div>
            <div class="col-md-4">
                <label class="form-label text-success fw-bold">Medication Type</label>
                <select id="medType" class="form-select">
                    <option value="Churan">Churan</option>
                    <option value="Diet Plan">Diet Plan</option>
                    <option value="Tonic">Tonic</option>
                    <option value="Tablet">Tablet</option>
                </select>
            </div>
            <div class="col-md-8">
                <label class="form-label text-success fw-bold">Dosage</label>
                <input type="text" id="dosage" class="form-control" placeholder=" 1 tsp daily" required>
            </div>
            <div class="col-12">
                <label class="form-label text-success fw-bold">Instructions</label>
                <input type="text" id="instructions" class="form-control" placeholder="Take with warm water after meals" required>
            </div>
            <div class="col-12">
                <label class="form-label text-success fw-bold">Recommended Exercises / Yoga</label>
                <textarea id="yoga" class="form-control" rows="2" placeholder="Surya Namaskar, Pranayama..."></textarea>
            </div>
            <div class="col-12 mt-4">
                <button type="submit" class="btn btn-success w-100 py-2 fw-bold">Issue Prescription</button>
            </div>
        </form>
    </div>
</div>

<script>
    const currentUser = JSON.parse(localStorage.getItem('user'));

    function initDoctorPortal() {
        if (!currentUser || currentUser.role !== 'doctor') {
            window.location.href = "Login.html";
            return;
        }
        loadPatients();
    }

    function loadPatients() {
        const select = document.getElementById('patientSelect');
        const allUsers = JSON.parse(localStorage.getItem('ayur_users')) || [];
        
        // Filter out doctors, keep only patients
        const patients = allUsers.filter(u => u.role === 'patient');

        select.innerHTML = '<option value="">-- Choose a Registered Patient --</option>';
        
        if (patients.length === 0) {
            select.innerHTML += '<option value="" disabled>No patients registered yet.</option>';
        } else {
            patients.forEach(p => {
                // Using email to securely link the prescription to the patient
                const name = p.full_name || p.name;
                select.innerHTML += `<option value="${p.email}">${name} (${p.email})</option>`;
            });
        }
    }

    // 2. Save prescription to localStorage
    document.getElementById('prescForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const newPrescription = {
            id: Date.now(),
            patient_email: document.getElementById('patientSelect').value,
            doctor_name: currentUser.full_name || currentUser.name,
            dosha_illness: document.getElementById('illness').value,
            medication_type: document.getElementById('medType').value,
            dosage: document.getElementById('dosage').value,
            instructions: document.getElementById('instructions').value,
            exercises_yoga: document.getElementById('yoga').value,
            date_issued: new Date().toLocaleDateString()
        };

        let allPrescriptions = JSON.parse(localStorage.getItem('ayur_prescriptions')) || [];
        allPrescriptions.push(newPrescription);
        localStorage.setItem('ayur_prescriptions', JSON.stringify(allPrescriptions));

        alert("Prescription successfully saved and sent to patient!");
        this.reset();
    });

    window.onload = initDoctorPortal;
</script>

</body>
</html>