<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard - Ayurcare</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --ayur-green: #2b7714;
            --ayur-green-dark: #1f570e;
            --sidebar-bg: #111827;
            --bg-light: #f3f6f4;
        }

        body { 
            background-color: var(--bg-light); 
            font-family: 'Inter', sans-serif; 
            color: #333;
        }

        /* Sidebar Styling */
        .sidebar { 
            background: var(--sidebar-bg); 
            min-height: 100vh; 
            color: #fff; 
            padding: 25px 20px; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .sidebar h3 { 
            font-weight: 800; 
            letter-spacing: 0.5px; 
            color: var(--ayur-green);
        }
        .sidebar a { 
            color: #9ca3af; 
            text-decoration: none; 
            display: block; 
            padding: 12px 15px; 
            margin-bottom: 8px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease; 
        }
        .sidebar a:hover { 
            color: #fff; 
            background-color: var(--ayur-green); 
            transform: translateX(5px);
        }
        .sidebar .text-danger:hover {
            background-color: rgba(220, 53, 69, 0.1);
            color: #ef4444 !important;
        }

        /* Stat Cards Styling */
        .stat-card { 
            border-radius: 16px; 
            border: none; 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .stat-card .card-body { padding: 25px; }
        .stat-card h6 { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.9; font-weight: 600; }
        .stat-card h3 { font-size: 2.5rem; font-weight: 800; margin-bottom: 0; }

        /* Custom Gradients for Stat Cards */
        .bg-primary { background: linear-gradient(135deg, var(--ayur-green), #42a322) !important; }
        .bg-info { background: linear-gradient(135deg, #0284c7, #38bdf8) !important; }
        .bg-warning { background: linear-gradient(135deg, #d97706, #fbbf24) !important; }

        /* General Cards & Buttons */
        .card { border-radius: 16px; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.04); }
        .card-title { font-weight: 700; color: #1f2937; margin-bottom: 1.5rem; }
        
        .btn-primary { background-color: var(--ayur-green); border-color: var(--ayur-green); font-weight: 600; padding: 10px 20px; border-radius: 8px; }
        .btn-primary:hover { background-color: var(--ayur-green-dark); border-color: var(--ayur-green-dark); }
        .btn-success { background-color: #0ea5e9; border-color: #0ea5e9; font-weight: 600; padding: 10px 20px; border-radius: 8px; }
        .btn-success:hover { background-color: #0284c7; border-color: #0284c7; }

        /* Header Elements */
        #doctorNameHeader { font-weight: 800; color: #111827; }
        .badge.bg-success { background-color: var(--ayur-green) !important; font-size: 0.85rem; padding: 8px 12px; border-radius: 6px; }

        /* Footer Styling */
        .footer { background-color: #ffffff; color: #4b5563; padding: 40px 0 20px; border-top: 1px solid #e5e7eb; margin-top: auto; }
        .footer h5 { color: var(--ayur-green); font-weight: 700; margin-bottom: 15px; font-size: 1.1rem; }
        .footer a { color: #6b7280; text-decoration: none; transition: 0.2s; display: block; margin-bottom: 8px; font-weight: 500; }
        .footer a:hover { color: var(--ayur-green); padding-left: 4px; }
        .footer-bottom { border-top: 1px solid #f3f4f6; padding-top: 20px; margin-top: 30px; text-align: center; font-size: 0.85rem; color: #9ca3af; font-weight: 500; }

        .border-primary { border-color: var(--ayur-green) !important; }
    </style>
</head>
<body>

<div class="container-fluid p-0 d-flex flex-column" style="min-height: 100vh;">
    <div class="row g-0 flex-grow-1">
        
        <nav class="col-md-3 col-lg-2 sidebar">
            <h3 class="mb-4 text-center">Ayurcare</h3>
            <a href="./Appointments.html">üìÖ Appointments</a>
            <a href="./Prescription.html">üìù Prescriptions</a>
            <a href="./StockProducts.html">üì¶ Medicine Stock</a>
            <hr class="border-secondary mt-4 mb-4">
            <a href="#" onclick="logout()" class="text-danger">üö™ Logout</a>
        </nav>

        <main class="col-md-9 col-lg-10 d-flex flex-column p-0">
            
            <div class="p-4 p-lg-5 flex-grow-1">
                <div class="d-flex justify-content-between align-items-center mb-5">
                    <h1 id="doctorNameHeader">Welcome, Doctor</h1>
                    <span class="badge bg-success shadow-sm">Status: Online</span>
                </div>

                <div class="row g-4 mb-5">
                    <div class="col-md-4">
                        <div class="card stat-card bg-primary text-white">
                            <div class="card-body">
                                <h6>Total Appointments</h6>
                                <h3 id="apptCount">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card stat-card bg-info text-white">
                            <div class="card-body">
                                <h6>Active Prescriptions</h6>
                                <h3 id="prescCount">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card stat-card bg-warning text-white">
                            <div class="card-body">
                                <h6>Low Stock Alerts</h6>
                                <h3 id="stockCount">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-5">
                    <div class="card-body p-4">
                        <h5 class="card-title">Quick Actions</h5>
                        <div class="d-flex gap-3">
                            <a href="./Appointments.html" class="btn btn-primary shadow-sm">Check Schedule</a>
                            <a href="./Prescription.html" class="btn btn-success shadow-sm">Write New Prescription</a>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <h5 class="card-title">Pending Appointment Requests</h5>
                        <div id="appointmentRequests">
                            </div>
                    </div>
                </div>
            </div>

            <footer class="footer px-4 px-lg-5">
                <div class="row g-4">
                    <div class="col-md-5">
                        <h5>Ayurcare Provider Portal</h5>
                        <p class="small pe-4 mb-0">Secure digital health management system designed specifically for Ayurvedic practitioners to seamlessly manage patients and pharmacy inventory.</p>
                    </div>
                    <div class="col-md-3">
                        <h5>Portal Links</h5>
                        <a href="Appointments.html">Schedule Overview</a>
                        <a href="StockProducts.html">Pharmacy Database</a>
                    </div>
                    <div class="col-md-4">
                        <h5>System Information</h5>
                        <p class="small mb-1">Version: Ayurcare v1.0</p>
                        <p class="small mb-1">Server Status: <span style="color: var(--ayur-green); font-weight: bold;">Operational</span></p>
                        <p class="small mb-0">Helpdesk: IT-support@ayurcare.com</p>
                    </div>
                </div>
                <div class="footer-bottom">
                    &copy; 2026 Ayurcare Digital Healthcare System. Confidential Medical Portal.
                </div>
            </footer>

        </main>
    </div>
</div>

<script>
    // 1. Get logged-in user securely
    let currentUserData = localStorage.getItem('user');
    let currentUser = null;
    
    if (currentUserData) {
        currentUser = JSON.parse(currentUserData);
    }

    // 2. Check Auth
    if (!currentUser || currentUser.role !== 'doctor') {
        window.location.href = "Login.html";
    }

    // 3. Start Dashboard
    function initDashboard() {
        let myName = currentUser.full_name || currentUser.name || "Doctor";
        document.getElementById('doctorNameHeader').innerText = "Welcome, Dr. " + myName;
        
        updateStats();
        renderAppointmentRequests();
    }

    // 4. Update the numbers in the colored boxes
    function updateStats() {
        let appointments = JSON.parse(localStorage.getItem('ayur_appointments')) || [];
        let prescriptions = JSON.parse(localStorage.getItem('ayur_prescriptions')) || [];
        let inventory = JSON.parse(localStorage.getItem('ayur_inventory')) || [];

        let myName = currentUser.full_name || currentUser.name;

        // Count only MY appointments
        let myApptCount = 0;
        for (let i = 0; i < appointments.length; i++) {
            if (appointments[i].doctor_name === myName) {
                myApptCount++;
            }
        }

        // Count only MY prescriptions
        let myPrescCount = 0;
        for (let i = 0; i < prescriptions.length; i++) {
            if (prescriptions[i].doctor_name === myName) {
                myPrescCount++;
            }
        }

        // Check for low stock (this is general for the clinic)
        let lowStockCount = 0;
        for (let i = 0; i < inventory.length; i++) {
            if (inventory[i].stock_qty < 5) {
                lowStockCount++;
            }
        }

        document.getElementById('apptCount').innerText = myApptCount;
        document.getElementById('prescCount').innerText = myPrescCount;
        document.getElementById('stockCount').innerText = lowStockCount;
    }

    // 5. Render only the requests meant for THIS doctor
    function renderAppointmentRequests() {
        let appointments = JSON.parse(localStorage.getItem('ayur_appointments')) || [];
        let requestContainer = document.getElementById('appointmentRequests');
        
        requestContainer.innerHTML = '';
        let myName = currentUser.full_name || currentUser.name;
        let pendingCount = 0;

        // Loop through all appointments
        for (let i = 0; i < appointments.length; i++) {
            let app = appointments[i];

            // The fix! Check if it is Scheduled AND if the doctor's name matches me
            if (app.status === 'Scheduled' && app.doctor_name === myName) {
                pendingCount++;
                
                // Get the patient name properly
                let pName = app.patient_name || app.patient_id || "Unknown Patient";

                let div = document.createElement('div');
                div.className = 'card mb-3 p-3 border-start border-primary border-4 shadow-sm';
                
                let cardHtml = '<div class="d-flex justify-content-between align-items-center">' +
                    '<div>' +
                        '<strong class="text-dark fs-5">Patient: ' + pName + '</strong><br>' +
                        '<small class="text-muted fw-bold">' + app.app_date + ' at ' + app.app_time + '</small>' +
                    '</div>' +
                    '<div class="btn-group">' +
                        '<button class="btn btn-sm btn-success fw-bold px-3" onclick="updateAppStatus(' + app.app_id + ', \'Completed\')">Accept</button>' +
                        '<button class="btn btn-sm btn-danger fw-bold px-3" onclick="updateAppStatus(' + app.app_id + ', \'Cancelled\')">Reject</button>' +
                    '</div>' +
                '</div>';

                div.innerHTML = cardHtml;
                requestContainer.appendChild(div);
            }
        }

        // If no pending appointments for me, show a message
        if (pendingCount === 0) {
            requestContainer.innerHTML = '<p class="text-muted">No pending requests at this time.</p>';
        }
    }

    // 6. Accept or Reject appointments
    function updateAppStatus(id, newStatus) {
        let savedData = localStorage.getItem('ayur_appointments');
        if (savedData) {
            let appointments = JSON.parse(savedData);
            
            for (let i = 0; i < appointments.length; i++) {
                if (appointments[i].app_id === id) {
                    appointments[i].status = newStatus;
                    break;
                }
            }
            
            localStorage.setItem('ayur_appointments', JSON.stringify(appointments));
            updateStats();
            renderAppointmentRequests();
        }
    }

    // 7. Logout
    function logout() {
        localStorage.removeItem('user');
        window.location.href = "Login.html";
    }

    window.onload = initDashboard;
</script>

</body>
</html>